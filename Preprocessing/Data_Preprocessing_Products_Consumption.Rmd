---
title: "Products_Wrangling"
author: "Rushi Kanjaria"
date: "2023-08-01"
output: html_document
---

```{R}
# Function to check if package is installed

required_packages <- c("tidyverse", "here", "rJava", "XLConnect", "dplyr", "janitor","stringr")

check_install_load <- function(packages) {
  for (package in packages) {
    if (!require(package, character.only = TRUE)) {
      install.packages(package, dependencies = TRUE)
      library(package, character.only = TRUE)
    }
  }
}

check_install_load(required_packages)
```

```{R}
production <- loadWorkbook(here("Raw_Data", "PT_Production.xls"))
consumption <- loadWorkbook(here("Raw_Data", "PT_Domestic_Consumption.xlsx"))

#Production
df_production <- readWorksheet(production, sheet = "PT_PRODUCTION_H", startRow = 11, endRow = 22, header = FALSE)

#Consumption
df_consumption <- readWorksheet(consumption, sheet = "Historical (year-wise)", startRow = 9, endRow = 20, header = FALSE)
```

```{R}
#Production Column names
colnames(df_production) <- c("Products","1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021")

#Consumption Column names
colnames(df_consumption) <- c("Products","1997","1998","Growth","1999","Growth","2000","Growth","2001","Growth","2002","Growth","2003","Growth","2004","Growth","2005","Growth","2006","Growth","2007","Growth","2008","Growth","2009","Growth","2010","Growth","2011","Growth","2012","Growth","2013","Growth","2014","Growth","2015","Growth","2016","Growth","2017","Growth","2018","Growth","2019","Growth","2020","Growth","2021","Growth","2022","Growth")
```

```{R}
#Removing the non-common columns
df_consumption <- df_consumption[, !names(df_consumption) %in% c("Growth","1997","2022")]
```

```{R}
#Production roundoff values
df_production <- df_production %>% 
  mutate(across(where(is.numeric), ~round(.,digits = 0)))

#Consumption roundoff values
df_consumption <- df_consumption %>% 
  mutate(across(where(is.numeric), ~round(.,digits = 0)))
```

```{R}
#Summing up non-common products into Other for Production dataframe 
temp_df_production <- df_production %>% filter(rownames(df_production) %in% c("8","12"))
column_sums_production <- colSums(temp_df_production[,sapply(temp_df_production, is.numeric)], na.rm = TRUE)
column_sums_production <- c("Others", column_sums_production)
df_production <- df_production[!(row.names(df_production) %in% c("8","12")),]
df_production <- rbind(df_production, column_sums_production)

#Summing up non-common products into Other for Consumption dataframe
temp_df_consumption <- df_consumption %>% filter(rownames(df_consumption) %in% c("8","11","12"))
column_sums_consumption <- colSums(temp_df_consumption[,sapply(temp_df_consumption, is.numeric)], na.rm = TRUE)
column_sums_consumption <- c("Others", column_sums_consumption)
df_consumption <- df_consumption[!(row.names(df_consumption) %in% c("8","11","12")),]
df_consumption <- rbind(df_consumption, column_sums_consumption)
```

```{R}
#Summing up FO & LSHS together to have same products as we have in Consumption dataframe
df_production <- df_production %>% mutate_at(c("1998","1999","2000","2001","2002","2003","2004","2005","2006","2007","2008","2009","2010","2011","2012","2013","2014","2015","2016","2017","2018","2019","2020","2021"), as.numeric)
temp_df_production <- df_production %>% filter(rownames(df_production) %in% c("9","10"))
column_sums_production <- colSums(temp_df_production[,sapply(temp_df_production, is.numeric)], na.rm = TRUE)
column_sums_production <- c("FO & LSHS", column_sums_production)
df_production <- df_production[!(row.names(df_production) %in% c("9","10")),]
df_production <- rbind(df_production, column_sums_production)
```


```{R}
#Production wide to long
df_production <- pivot_longer(df_production, c("1998":"2021"), names_to = "Year", values_to = "Production_Quantity")

#Consumption wide to long
df_consumption <- pivot_longer(df_consumption, c("1998":"2021"), names_to = "Year", values_to = "Consumption_Quantity")
```

```{R}
#Production typecasting
df_production$Year <- as.numeric(df_production$Year)
df_production$Production_Quantity <- as.numeric(df_production$Production_Quantity)

#Consumption typecasting
df_consumption$Year <- as.numeric(df_consumption$Year)
df_consumption$Consumption_Quantity <- as.numeric(df_consumption$Consumption_Quantity)
```

```{R}
#Joining both the dataframes into a single dataframe
df_prod_consum <- merge(df_production, df_consumption, by = c("Products", "Year"))
```

```{R}
#Exporting the final dataframe into the local system
write.csv(df_prod_consum, file = here("Data", "Production_Consumption.csv"), row.names = FALSE)
```
